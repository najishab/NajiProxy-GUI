name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to create release for (e.g., v1.0.0)"
        required: true
        default: "v1.0.0"

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Set environment variable
        run: echo "USE_HARD_LINKS=false" >> $GITHUB_ENV

      - name: Update electron-builder
        run: npm install -g electron-builder@latest

      - name: Cleanup Project
        run: npm cache clean --force

      - name: Install Dependencies
        run: npm install

      - name: Build Electron App (Windows x64)
        if: matrix.os == 'windows-latest'
        run: npx electron-builder --win --x64 --publish never

      - name: Build Electron App (Windows ia32)
        if: matrix.os == 'windows-latest'
        run: npx electron-builder --win --ia32 --publish never

      - name: Build Electron App (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: npx electron-builder --linux --publish never

      - name: Build Electron App (macOS x64)
        if: matrix.os == 'macos-latest'
        run: npx electron-builder --mac --x64 --publish never

      - name: Build Electron App (macOS arm64)
        if: matrix.os == 'macos-latest'
        run: npx electron-builder --mac --arm64 --publish never

      - name: Create Windows Portable ZIP with Folder Structure
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          # Create zip file for x64 win-unpacked folder
          if (Test-Path "dist/win-unpacked") {
            Compress-Archive -Path "dist/win-unpacked" -DestinationPath "dist/proxycloud-gui-win-unpacked.zip"
          }
          
          # Create zip file for ia32 win-unpacked folder if it exists
          if (Test-Path "dist/win-ia32-unpacked") {
            Compress-Archive -Path "dist/win-ia32-unpacked" -DestinationPath "dist/proxycloud-gui-win-ia32-unpacked.zip"
          }

      - name: Upload Artifact (Windows Portable EXE)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: proxycloud-gui-win-portable
          path: |
            dist/*portable.exe
            dist/win-ia32-*portable.exe

      - name: Upload Artifact (Windows Portable ZIP with Folder)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: proxycloud-gui-win-unpacked
          path: |
            dist/proxycloud-gui-win-unpacked.zip
            dist/proxycloud-gui-win-ia32-unpacked.zip

      - name: Upload Artifact (Windows EXE)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: proxycloud-gui-win-exe
          path: |
            dist/*.exe
            !dist/*portable.exe
            !dist/win-ia32-*portable.exe

      - name: Upload Artifact (Windows ia32 EXE)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: proxycloud-gui-win-ia32-exe
          path: |
            dist/win-ia32-*.exe
            !dist/win-ia32-*portable.exe

      - name: Upload Artifact (Linux DEB)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: proxycloud-gui-linux-deb
          path: dist/*.deb

      - name: Upload Artifact (Linux TAR.GZ)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: proxycloud-gui-linux-tar
          path: dist/*.tar.gz

      - name: Upload Artifact (Linux RPM)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: proxycloud-gui-linux-rpm
          path: dist/*.rpm

      - name: Upload Artifact (Linux AppImage)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: proxycloud-gui-linux-appimage
          path: dist/*.AppImage

      - name: Upload Artifact (macOS DMG x64)
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: proxycloud-gui-macos-dmg-x64
          path: dist/*-x64.dmg

      - name: Upload Artifact (macOS ZIP x64)
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: proxycloud-gui-macos-zip-x64
          path: dist/*-x64.zip

      - name: Upload Artifact (macOS DMG arm64)
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: proxycloud-gui-macos-dmg-arm64
          path: dist/*-arm64.dmg

      - name: Upload Artifact (macOS ZIP arm64)
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: proxycloud-gui-macos-zip-arm64
          path: dist/*-arm64.zip

  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/**/*.*
          tag_name: ${{ github.event.inputs.tag || github.ref_name }}
          name: Release ${{ github.event.inputs.tag || github.ref_name }}
          body: |
            ## ProxyCloud GUI ${{ github.event.inputs.tag || github.ref_name }}

            ### üì• Downloads

            #### Windows
            - [üì¶ Windows Installer (.exe)](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.tag || github.ref_name }}/proxycloud-gui-win-x64.exe)
            - [üíº Windows Portable (.exe)](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.tag || github.ref_name }}/proxycloud-gui-win-portable.exe)
            - [üìÇ Windows Portable (.zip)](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.tag || github.ref_name }}/proxycloud-gui-win-unpacked.zip)
            - [üì¶ Windows 7 32-bit Installer (.exe)](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.tag || github.ref_name }}/proxycloud-gui-win-ia32.exe)
            - [üíº Windows 7 32-bit Portable (.exe)](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.tag || github.ref_name }}/proxycloud-gui-win-ia32-portable.exe)
            - [üìÇ Windows 7 32-bit Portable (.zip)](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.tag || github.ref_name }}/proxycloud-gui-win-ia32-unpacked.zip)

            **Important Notes for Windows Portable Version:**
            - Run the application as Administrator for proper functionality
            - For more information, see [Windows Portable Version Notes](https://github.com/code3-dev/ProxyCloud-GUI#important-notes-for-windows-portable-version)

            #### macOS
            - [üçé macOS Intel (x64) (.dmg)](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.tag || github.ref_name }}/proxycloud-gui-mac-x64.dmg)
            - [üçé macOS Apple Silicon (arm64) (.dmg)](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.tag || github.ref_name }}/proxycloud-gui-mac-arm64.dmg)
            - [üì¶ macOS Intel (x64) (.zip)](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.tag || github.ref_name }}/proxycloud-gui-mac-x64.zip)
            - [üì¶ macOS Apple Silicon (arm64) (.zip)](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.tag || github.ref_name }}/proxycloud-gui-mac-arm64.zip)

            **Important Notes for macOS:**
            - Configure required permissions through System Settings ‚Üí Privacy & Security
            - Enable Automation, Accessibility, Full Disk Access, and System Extension/VPN permissions
            - For more information, see [macOS Notes](https://github.com/code3-dev/ProxyCloud-GUI#macos)

            #### Linux
            - [üêß Linux (.deb)](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.tag || github.ref_name }}/proxycloud-gui-linux-amd64.deb)
            - [üêß Linux (.rpm)](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.tag || github.ref_name }}/proxycloud-gui-linux-x86_64.rpm)
            - [üêß Linux (.AppImage)](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.tag || github.ref_name }}/proxycloud-gui-linux-x86_64.AppImage)
            - [üêß Linux (.tar.gz)](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.tag || github.ref_name }}/proxycloud-gui-linux-x64.tar.gz)

            **Running in TUN Mode (Linux):**
            - Requires root access with the following commands:
              ```bash
              xhost +SI:localuser:root
              sudo -E proxycloud-gui --no-sandbox
              xhost -SI:localuser:root
              ```
            - For more information, see [Linux TUN Mode Notes](https://github.com/code3-dev/ProxyCloud-GUI#running-in-tun-mode-linux)

            #### Arch Linux

            ProxyCloud is now on the [AUR](https://aur.archlinux.org/packages/proxycloud-gui-bin), therefore you can install it using your prefered AUR helper.

            ```bash
            paru -S proxycloud-gui-bin

            # or if you are using yay

            yay -S proxycloud-gui-bin
            ```

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}